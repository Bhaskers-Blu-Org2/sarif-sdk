<Project ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <PropertyGroup>
    <MSBuildAllProjects>$(MSBuildAllProjects);$(MSBuildThisFileFullPath)</MSBuildAllProjects>
  </PropertyGroup>

  <!-- NOTE: Requires settings 'JsonSchemaFile', 'BsoaVersion', 'FlavorIndependentIntermediateOutputPath' -->
  <PropertyGroup>
    <BsoaFromJSchema>$(MSBuildThisFileDirectory)\bin\BSOA.FromJSchema.exe</BsoaFromJSchema>
    <BsoaGenerator>$(MSBuildThisFileDirectory)\bin\BSOA.Generator.exe</BsoaGenerator>
    <_ObjectModelOutputDirectory>$(FlavorIndependentIntermediateOutputPath)Autogenerated</_ObjectModelOutputDirectory>
  </PropertyGroup>
  
  <!-- This target runs only when we actually need to build the object model files, which should be
       only when the JSON schema changes. -->
  <Target Name="BuildObjectModel" Inputs="@(JsonSchemaFile)" Outputs="$(_ObjectModelOutputDirectory)\*.cs">
    <Message Importance="high" Text="Installing BSOA Generators..." />
    <Exec Command="dotnet tool install BSOA.Generator --version &quot;$(BsoaVersion)&quot; --tool-path &quot;$(MSBuildThisFileDirectory)\bin&quot;" IgnoreExitCode="true" />
    <Exec Command="dotnet tool install Bsoa.FromJSchema  --version &quot;$(BsoaVersion)&quot; --tool-path &quot;$(MSBuildThisFileDirectory)\bin&quot;" IgnoreExitCode="true" />
    
    <Message Importance="high" Text="Generating SARIF object model..." />
    <Exec Command="&quot;$(BsoaFromJSchema)&quot; &quot;@(JsonSchemaFile)&quot; &quot;@(JsonSchemaFile).schema.json&quot; &quot;SarifLog&quot; &quot;Microsoft.CodeAnalysis.Sarif&quot;" />
    <Exec Command="&quot;$(BsoaGenerator)&quot; &quot;@(JsonSchemaFile).schema.json&quot; &quot;$(_ObjectModelOutputDirectory)&quot; &quot;$(MSBuildThisFileDirectory)\Templates\Sarif&quot; &quot;$(MSBuildThisFileDirectory)\Schemas\Sarif.postReplacements.json&quot;" />

    <Message Text="Done. Generated classes from @(JsonSchemaFile) -> $(_ObjectModelOutputDirectory)"/>
  </Target>
  <!--
  This target runs every build. It regenerates the SARIF object model classes
  from the JSON schema.
  -->
  <Target Name="BuildAndInjectObjectModel">
    <!-- Build the object model if necessary. -->
    <CallTarget Targets="BuildObjectModel" />
  </Target>
</Project>